---
title: "Sensitivity Analysis"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 8,
  fig.height = 8
)

local({
  hook_old <- knitr::knit_hooks$get("source")  # save the old hook
  knitr::knit_hooks$set(source = function(x, options) {
    if (!is.null(options$hide_src) && options$hide_src) {
      return(
        c("<details>
          <summary style='font-size:0.8em; margin-bottom:0; color: #666;>
          Show/Hide Code
          </summary>\n", 
          hook_old(x, options), 
          "</details>")
      )
    }
    hook_old(x, options)
  })
})
```

```{r}
#| include: false
library(sf)
library(mapview)
library(rems)
library(dplyr)
library(gt)
library(ggplot2)
library(ggrepel)
library(latex2exp)

sites_sf <- structure(list(emsid = c("0400390", "0500236", "E207466"), name = c("CHARLIE L DEEP STATION 1.2 KM EAST OF PARK", 
"OKANAGAN L D/S KELOWNA STP (DEEP)", "QUAMICHAN LAKE; CENTRE"
), lon = c(-120.9642, -119.5134, -123.6625), lat = c(56.3125, 
49.8614, 48.8003), elev_m = c(693, 342, 25), date = structure(c(1629823800, 
1631127600, 1629918000), tzone = "Etc/GMT+8", class = c("POSIXct", 
"POSIXt")), DOC = c(14, 4.26, 6.61), doc_min = c(0.96, 4.06, 
6.37), doc_max = c(15.4, 5.17, 11.8), geometry = structure(list(
    structure(c(-120.9642, 56.3125), class = c("XY", "POINT", 
    "sfg")), structure(c(-119.5134, 49.8614), class = c("XY", 
    "POINT", "sfg")), structure(c(-123.6625, 48.8003), class = c("XY", 
    "POINT", "sfg"))), class = c("sfc_POINT", "sfc"), precision = 0, crs = structure(list(
    input = "EPSG:4326", wkt = "GEOGCRS[\"WGS 84\",\n    ENSEMBLE[\"World Geodetic System 1984 ensemble\",\n        MEMBER[\"World Geodetic System 1984 (Transit)\"],\n        MEMBER[\"World Geodetic System 1984 (G730)\"],\n        MEMBER[\"World Geodetic System 1984 (G873)\"],\n        MEMBER[\"World Geodetic System 1984 (G1150)\"],\n        MEMBER[\"World Geodetic System 1984 (G1674)\"],\n        MEMBER[\"World Geodetic System 1984 (G1762)\"],\n        MEMBER[\"World Geodetic System 1984 (G2139)\"],\n        ELLIPSOID[\"WGS 84\",6378137,298.257223563,\n            LENGTHUNIT[\"metre\",1]],\n        ENSEMBLEACCURACY[2.0]],\n    PRIMEM[\"Greenwich\",0,\n        ANGLEUNIT[\"degree\",0.0174532925199433]],\n    CS[ellipsoidal,2],\n        AXIS[\"geodetic latitude (Lat)\",north,\n            ORDER[1],\n            ANGLEUNIT[\"degree\",0.0174532925199433]],\n        AXIS[\"geodetic longitude (Lon)\",east,\n            ORDER[2],\n            ANGLEUNIT[\"degree\",0.0174532925199433]],\n    USAGE[\n        SCOPE[\"Horizontal component of 3D system.\"],\n        AREA[\"World.\"],\n        BBOX[-90,-180,90,180]],\n    ID[\"EPSG\",4326]]"), class = "crs"), n_empty = 0L, bbox = structure(c(xmin = -123.6625, 
ymin = 48.8003, xmax = -119.5134, ymax = 56.3125), class = "bbox"))), row.names = c(NA, 
-3L), sf_column = "geometry", agr = structure(c(emsid = NA_integer_, 
name = NA_integer_, lon = NA_integer_, lat = NA_integer_, elev_m = NA_integer_, 
date = NA_integer_, DOC = NA_integer_, doc_min = NA_integer_, 
doc_max = NA_integer_), levels = c("constant", "aggregate", "identity"
), class = "factor"), class = c("sf", "tbl_df", "tbl", "data.frame"
))

`%||%` <- function(x, y) if (is.null(x)) y else x
```

This report is to document the sensitivity of the TUV model, and the subsequent
calculation of water quality guidelines for PAHs, to variation in certain PAH
parameters.

## Input parameters

The input parameters for the calculation of light attenuation through water for
the TUV model are: 

  * Vertical Attenuation Coefficient at wavelength `wvl`: $kvat = k_de^{-Sk(ref\_wvl-wvl)}$
      - **`Kd`** Light attenuation coefficient (set directly or calculated from DOC)
      - **`Sk`** (default `0.018`)
      - **`ref_wvl`** Reference wavelength for `Kd` (default `305`)
  * **`depth_m`** Water depth in m
  * **`lat`** Latitude in decimal degrees
  * **`lon`** Longitude in decimal degrees
  * **`elev_km`** Surface elevation, km above sea level
  * **`year`** Year
  * **`month`** Month
  * **`day`** Day
  * **`tzone`** Timezone  Local Time - UTC (default `0`; UTC)
  * **`tstart`** Start time, hours local time (default `0`)
  * **`tstop`** Stop time, hours local time (default `23`)
  * **`tsteps`** Number of time steps (default `24`)
  * **`albedo`** Surface albedo (default `0.07`)
  * **`o3_tc`** Ozone column, Dobson Units (DU) - Looked up in climatology (recommended default `300`)
  * **`so2_tc`** SO2 column, DU (default `0`)
  * **`no2_tc`** NO2 column, DU (default `0`)
  * **`taucld`** Cloud optical depth (default `0`)
  * **`zbase`** Cloud base, km (default `4`)
  * **`ztop`** Cloud top, km (default `5`)
  * **`tauaer`** Aerosol optical depth at 550 nm - Looked up in climatology (recommended default `0.235`)
  * **`ssaaer`** Aerosol single scattering albedo (default `0.990`)
  * **`alpha`** Aerosol Angstrom exponent(default `1.0`) 
  * **`wvl_start`** Starting wavelength, nm (default `279.5`)
  * **`wvl_end`** End wavelength, nm (default `400.5`)
  * **`wvl_steps`** Number of wavelength intervals (default `121`)
  * **`nstr`** TUV run type; use -2 for fast, 4 for slightly more accurate (default `-2`)

Those currently under consideration for sensitivity analysis are:

  * **`Kd`** Light attenuation coefficient - includes use of **`DOC`** for calculating `Kd`
  * **`lat`** Latitude in decimal degrees
  * **`lon`** Longitude in decimal degrees
  * **`elev_km`** Surface elevation, km above sea level
  * **`albedo`** Surface albedo (default `0.07`)
  * **`o3_tc`** Ozone column, Dobson Units (DU) - Looked up in climatology (recommended default `300`)
  * **`tauaer`** Aerosol optical depth at 550 nm - Looked up in climatology (recommended default `0.235`)
  * **`ssaaer`** Aerosol single scattering albedo (default `0.990`)
  * **`nstr`** TUV run type; use -2 for fast, 4 for slightly more accurate (default `-2`)
  
The analyses will be conducted at three different sample lakes 
(Southern Interior, Vancouver Island, Northeast),
using two PAHs (Anthracene and Benzo[a]pyrene).

Initially, sensitivity analyses will be univariate (varying the input of interest
while holding the others constant). If there are significant interactions expected
between certain variables, these can be explored.

## Basic usage of the `pahwq` package

To calculate the acute phototoxic water quality guideline (PLC50) for Anthracene 
at 0.25 m depth in Okanagan Lake on June 21, 2023, with a measured DOC of 5 g/m^3, 
you would use the following code:

First, set up the options for the model run:
```{r}
library(pahwq)

set_tuv_aq_params(
  depth_m = 0.25,
  lat = 49.601632,
  lon = -119.605862,
  elev_km = 0.342,
  DOC = 5,
  date = "2023-06-21",
  tzone = -8,
  albedo = 0.05
)
```

You can view the options that will be used by TUV. Some are set via the function
inputs, and some are looked up:

```{r}
view_tuv_aq_params()
```

Run the TUV model and get the results. The results show the underwater irradiance 
at the specified depth, at each wavelength and time step.

```{r}
run_tuv()

# Get the results
res <- get_tuv_results(file = "out_irrad_y")
head(res)
```

Calculate the site-specific light absorption ($P_{abs}$) for Anthracene from the 
TUV results. The `p_abs()` function uses a lookup table to get the molar 
absorption coefficient for the specified PAH.

```{r}
(Pabs <- p_abs(res, "Anthracene"))
```

Finally, calculate PLC50 in 𝝁g/L, supplying the $P_{abs}$ value and NLC50 (𝝁g/L):

```{r}
plc_50(Pabs, pah = "Anthracene")
```

## Setup

We'll start by loading the packages we need and getting some data from B.C. EMS:

```{r setup, hide_src = TRUE}
#| eval: false
library(sf)
library(mapview)
library(rems)
library(dplyr)
library(ggplot2)
library(ggrepel)
library(latex2exp)

con <- connect_historic_db()
db <- attach_historic_data(con)
sites_sf <- db |> 
  filter(
    EMS_ID %in% c("0500236", "E207466", "0400390"),
    # grepl("(CHARLIE L)|(OKANAGAN)|(QUAMICHAN)", MONITORING_LOCATION), 
    COLLECTION_START > as.Date("2020-01-01"), PARAMETER_CODE == "1103"
  ) |> 
  collect() |> 
  st_as_sf(coords = c("LONGITUDE", "LATITUDE"), crs = 4326, remove = FALSE) |> 
  filter(!is.na(RESULT)) |> 
  arrange(desc(COLLECTION_START)) |> 
  group_by(EMS_ID, MONITORING_LOCATION, LONGITUDE, LATITUDE) |> 
  mutate(doc_min = min(RESULT), doc_max = max(RESULT)) |> 
  slice(1) |> 
  select(emsid = EMS_ID, 
         name = MONITORING_LOCATION, 
         lon = LONGITUDE, 
         lat = LATITUDE, 
         date = COLLECTION_START, 
         DOC = RESULT,
         doc_min,
         doc_max) |> 
  left_join(
    tribble(
      ~ emsid, ~elev_m,
      "E207466", 25,
      "0400390", 693,
      "0500236", 342
    ), by = join_by("emsid")
  ) |> 
  ungroup() |> 
  relocate(elev_m, .after = lat)

disconnect_historic_db(con)
```


## Locations
```{r hide_src=TRUE}
mapview(sites_sf, zcol = "name", legend = FALSE)
```

### Okanagan Lake, Okanagan

* EMS ID: 0500236
* Region: Okanagan 
* Latitude: 49.8614 N
* Longitude: 119.5134 W
* Site Depth: 70.1 m 
* Maximum Lake Depth: 232 m
* Lake Elevation: 342 m 
* Lake Surface Area: 350.08 sq km

### Charlie Lake, Peace

* EMS ID: 0400390
* Region: Peace 
* Latitude: 56.3125 N
* Longitude: 120.9642 W
* Site Depth: 13 m 
* Maximum Lake Depth: 13 m
* Lake Elevation: 693 m 
* Lake Surface Area: 17.56 sq km

### Quamichan Lake, Vancouver Island

* EMS ID: E207466
* Region: Vancouver Island 
* Latitude: 48.8003 N
* Longitude: 123.6625 W
* Site Depth: 7 m 
* Maximum Lake Depth: 8 m
* Lake Elevation: 25 m 
* Lake Surface Area: 2.88 sq km

### Prepare the data for comparisons, including setting the date to be the same
for all sites:

```{r hide_src=TRUE}
sites <- sites_sf |> 
  st_drop_geometry()
```

```{r}
sites <- sites |> 
  mutate(date = "2023-08-01")
gt(sites)
```

## Basic analysis using defaults

We will first define a function, `multi_tuv()` that allows us to do repeated 
runs of the TUV model and PLC50 calculation using a range of inputs.

```{r multi-tuv, hide_src=TRUE}
multi_tuv <- function(df, site = "name", pah, varying, vals = NULL, ...) {
  if (!varying %in% union(names(tuv_aq_defaults()), names(formals(set_tuv_aq_params)))) {
    stop(varying, " is not a valid argument for `set_tuv_aq_params()`")
  }
  
  if (!is.null(vals)) {
    var_df <- data.frame(vals)
    names(var_df) <- varying
    
    df <- df |> 
      select(!any_of(varying)) |> 
      dplyr::cross_join(var_df)
  }
  
  df |> 
    rowwise() |> 
    mutate(
      Pabs = calc_Pabs(
          date = date, 
          lat = lat, 
          lon = lon,
          elev_m = elev_m,
          pah = pah,
          varying = .data[[varying]],
          vary_var = varying,
          ...
        ),
      plc50 = plc_50(Pabs, pah = pah),
      plc_nlc_ratio = plc50 / nlc50(pah)
    )
}

calc_Pabs <- function(date, lat, lon, elev_m, pah, varying, vary_var, ...) {
  args <- c(
    varying, 
    list(
      depth_m = 0.25,
      date = as.Date(date),
      lat = lat,
      lon = lon,
      elev_km = elev_m / 1000
    ),
    ...
  )
  names(args)[1] <- vary_var
  
  # allow overriding of one of the core args by one supplied in 'varying', 
  # this will keep the first of duplicated argument names, which will
  # be the one in 'varying'
  args <- args[unique(names(args))]
  
  do.call("set_tuv_aq_params", args)
  
  run_tuv(quiet = TRUE)
  res <- get_tuv_results(file = "out_irrad_y")
  p_abs(res, pah)
}
```

We then use the `multi_tuv()` function to calculate $P_{abs}$, PLC50, and ratio of PLC50:NLC50 for Anthracene using recorded DOC values at the three sites. This also uses
the utility of pahwq to look up ozone column and aerosol optical depth from
climatologies based on latitude, longitude, and month.

```{r hide_src=TRUE}
diff_DOC <- multi_tuv(sites, pah = "Anthracene", varying = "DOC")
```

```{r}
#| echo: false
diff_DOC |>
  select(-doc_min, -doc_max) |>
  gt() |>
  data_color(columns = plc50, palette = "Greens")
```

We can then modify the data to set a constant [DOC] (DOC = 5), and calculate $P_{abs}$, PLC50, and ratio of PLC50:NLC50 for Anthracene using constant DOC = 5: 

```{r hide_src=TRUE}
same_DOC <- sites |>
  mutate(DOC = 5) |>
  multi_tuv(pah = "Anthracene", varying = "DOC")
```

```{r}
#| echo: false
same_DOC |>
  select(-doc_min, -doc_max) |>
  gt() |>
  data_color(columns = plc50, palette = "Greens")
```

## Light Attenuation Coefficicent ($k_d$)

The TUV model calculates the light attenuation coefficient $k_d(λ)$ for each wavelength, based
on a reference $k_d(λ_{ref})$, where $\lambda_{ref}$ is the reference wavelength. 

$k_d(λ_{ref})$ at 305nm ($k_{d,305}$) can be estimated from Dissolved Organic Carbon concentration [DOC] using the equation:

$k_{d,305} = a_{305}[DOC]^{b_{305}} + 0.13$; $a_{305}$ = 2.76 and $b_{305}$ = 1.23 (Morris et al 1995; Equation 4-1a in ARIS 2023)

For the sensitivity analysis for $k_d$, it is more interpretable to supply 
a range of $k_d$ values to the TUV model directly, even though in practice it is 
more likely to use [DOC] to estimate $k_d$.

Using sample $k_d$ values from Table 3 (ARIS 2023), from 0.08 to 275:

```{r hide_src=TRUE}
kd_vals <- seq(0.08, 275, length.out = 20)
```

### Effect of varying $k_d$ on PLC50 and ratio of PLC50:NLC50 for Anthracene

```{r hide_src=TRUE}
kd_test_a <- multi_tuv(sites, 
                      pah = "Anthracene", 
                      varying = "Kd_ref", 
                      vals = kd_vals, 
                      Kd_wvl = 305,
                      o3_tc = 300,
                      tauaer = 0.235)

ggplot(kd_test_a, aes(x = Kd_ref, y = plc50)) +
  geom_point() + 
  facet_wrap(vars(name), ncol = 1) +
  theme_bw() + 
  labs(
    title = TeX(r"(PLC50 for Anthracene at 3 sites in B.C. for a range of $k_d(305)$)"), 
    x = TeX(r"($k_d(305)$)"),
    y = "PLC50 (μg/L)"
    )

ggplot(kd_test_a, aes(x = Kd_ref, y = plc_nlc_ratio)) +
  geom_point() + 
  facet_wrap(vars(name), ncol = 1) +
  theme_bw() + 
  labs(
    title = TeX(r"(Ratio of PLC50:NLC50 for Anthracene at 3 sites in B.C. for a range of $k_d(305)$)"), 
    x = TeX(r"($k_d(305)$)"),
    y = "Ratio of PLC50:NLC50"
    )
```

For Anthracene, the ratio of PLC50:NLC50 approaches 1 when $k_d(305)$ is ~ 
250 --- in other words at that level of $k_d$, PLC50 is nearly the same as NLC50, 
indicating that the light is attenuated to such an extent that the phototoxicity 
of Anthracene is not activated at the light levels when $k_d(305)$ >= 250.

According to the above equation for estimating $k_d$ from [DOC]: 

$250 = 2.76[DOC]^{1.23} + 0.13$
[DOC] ~= 40

Therefore $k_d(305)$ of ~250 is representative of light attenuation when [DOC] 
is ~40. This is a significantly higher DOC concentration than observed in our 
three sample lakes, and is outside the range for which the above equation is 
recommended (it is recommended for [DOC] between 0.2 and 23 mg/L).

### Effect of varying $k_d$  on PLC50 and ratio of PLC50:NLC50 for Benzo[a]pyrene

```{r hide_src=TRUE}
kd_test_b <- multi_tuv(sites, 
                      pah = "Benzo[a]pyrene", 
                      varying = "Kd_ref", 
                      vals = kd_vals,
                      o3_tc = 300,
                      tauaer = 0.235)

ggplot(kd_test_b, aes(x = Kd_ref, y = plc50)) +
  geom_point() + 
  facet_wrap(vars(name), ncol = 1) +
  theme_bw() + 
  labs(
    title = "PLC50 for Benzo[a]pyrene at 3 sites in B.C. for a range of $k_d(305)$", 
    x = "$k_d(305)$",
    y = "PLC50 (μg/L)"
    )

ggplot(kd_test_b, aes(x = Kd_ref, y = plc_nlc_ratio)) +
  geom_point() + 
  facet_wrap(vars(name), ncol = 1) +
  theme_bw() + 
  labs(
    title = "Ratio of PLC50:NLC50 for Benzo[a]pyrene at 3 sites in B.C. for a range of $k_d(305)$", 
    x = "$k_d(305)$",
    y = "Ratio of PLC50:NLC50"
    )
```

## Surface Albedo (`albedo`)

We test surface albedo values from 0.05 to 0.1 (typical for water), and include 
the suggested default of 0.7:

```{r}
albedo_vals <- c(seq(0.05, 0.1, length.out = 10), 0.07)
```

We will set DOC = 5 for all sites, and test the range of surface albedo values
at all three sites for Anthracene and Benzo[a]pyrene.

### Effect of varying Surface Albedo on PLC50 and ratio of PLC50:NLC50 for Anthracene

```{r hide_src=TRUE}
albedo_test_a <- multi_tuv(sites, 
                      pah = "Anthracene", 
                      varying = "albedo", 
                      vals = albedo_vals,
                      DOC = 5,
                      o3_tc = 300,
                      tauaer = 0.235)

ggplot(albedo_test_a, aes(x = albedo, y = plc50)) +
  geom_point() + 
  facet_wrap(vars(name), ncol = 1) +
  geom_point(
    data = filter(albedo_test_a, albedo == 0.07), 
    aes(x = albedo, y = plc50),
    colour = "red"
  ) + 
  geom_text_repel(
    data = filter(albedo_test_a, albedo == 0.07, name == "QUAMICHAN LAKE; CENTRE"), 
    aes(x = albedo, y = plc50),
    colour = "red", 
    label = "Recommended default = 0.07",
    nudge_x = 0.001,
    nudge_y = 0.25
  ) +
  theme_bw() + 
  labs(
    title = "PLC50 for Anthracene at 3 sites in B.C. for a range of Surface Albedo", 
    x = "Surface Albedo",
    y = "PLC50 (μg/L)"
  )

ggplot(albedo_test_a, aes(x = albedo, y = plc_nlc_ratio)) +
  geom_point() + 
  facet_wrap(vars(name), ncol = 1) +
    geom_point(
    data = filter(albedo_test_a, albedo == 0.07), 
    aes(x = albedo, y = plc_nlc_ratio),
    colour = "red"
  ) + 
  geom_text_repel(
    data = filter(albedo_test_a, albedo == 0.07, name == "QUAMICHAN LAKE; CENTRE"), 
    aes(x = albedo, y = plc_nlc_ratio),
    colour = "red", 
    label = "Recommended default = 0.07",
    nudge_x = 0.001,
    nudge_y = 0.0005
  ) +
  theme_bw() + 
  labs(
    title = "Ratio of PLC50:NLC50 for Anthracene at 3 sites in B.C. for a range of Surface Albedo", 
    x = "Surface Albedo",
    y = "Ratio of PLC50:NLC50"
    )
```

### Effect of varying Surface Albedo on PLC50 and ratio of PLC50:NLC50 for Benzo[a]pyrene

```{r hide_src=TRUE}
albedo_test_b <- multi_tuv(sites, 
                      pah = "Benzo[a]pyrene", 
                      varying = "albedo", 
                      vals = albedo_vals,
                      DOC = 5,
                      o3_tc = 300,
                      tauaer = 0.235)

ggplot(albedo_test_b, aes(x = albedo, y = plc50)) +
  geom_point() + 
  facet_wrap(vars(name), ncol = 1) +
    geom_point(
    data = filter(albedo_test_b, albedo == 0.07), 
    aes(x = albedo, y = plc50),
    colour = "red"
  ) + 
  geom_text_repel(
    data = filter(albedo_test_b, albedo == 0.07, name == "QUAMICHAN LAKE; CENTRE"), 
    aes(x = albedo, y = plc50),
    colour = "red", 
    label = "Recommended default = 0.07",
    nudge_x = 0.001,
    nudge_y = 0.1
  ) +
  theme_bw() + 
  labs(
    title = "PLC50 for Benzo[a]pyrene at 3 sites in B.C. for a range of Surface Albedo", 
    x = "Surface Albedo",
    y = "PLC50 (μg/L)"
    )

ggplot(albedo_test_b, aes(x = albedo, y = plc_nlc_ratio)) +
  geom_point() + 
  facet_wrap(vars(name), ncol = 1) +
    geom_point(
    data = filter(albedo_test_b, albedo == 0.07), 
    aes(x = albedo, y = plc_nlc_ratio),
    colour = "red"
  ) + 
  geom_text_repel(
    data = filter(albedo_test_b, albedo == 0.07, name == "QUAMICHAN LAKE; CENTRE"), 
    aes(x = albedo, y = plc_nlc_ratio),
    colour = "red", 
    label = "Recommended default = 0.07",
    nudge_x = 0.001,
    nudge_y = 0.0003
  ) +
  theme_bw() + 
  labs(
    title = "Ratio of PLC50:NLC50 for Benzo[a]pyrene at 3 sites in B.C. for a range of Surface Albedo", 
    x = "Surface Albedo",
    y = "Ratio of PLC50:NLC50"
    )
```

## Ozone Column (`o3_tc`)

The pahwq package currently uses average monthly ozone column data from 1980-1991, 
which is bundled with the TUV model from Fortuin and H. Kelder, 1998. Based on 
latitude and longitude and month, the ozone column value is looked up and supplied
to the TUV model. This default behaviour can be overridden by supplying a value to 
the `o3_tc` argument in the `set_tuv_aq_params` function. In the absence of
climatological data, the recommended default value is 300 DU (ARIS 2023).

To test the sensitivity of PLC50 to ozone column, a range of values is tested from
280-420 DU, which are typical values in middle to Northern latitudes. See [NASA's 'Ozone Watch' page](https://ozonewatch.gsfc.nasa.gov/facts/dobson_SH.html) for more information on atmospheric ozone.

```{r hide_src=TRUE}
ozone_vals <- seq(280, 420, by = 10)
```

### Effect of varying Ozone Total Column on PLC50 and ratio of PLC50:NLC50 for Anthracene

```{r hide_src=TRUE}
ozone_test_a <- multi_tuv(sites, 
                      pah = "Anthracene", 
                      varying = "o3_tc", 
                      vals = ozone_vals,
                      DOC = 5,
                      tauaer = 0.235)

ggplot(ozone_test_a, aes(x = o3_tc, y = plc50)) +
  geom_point() + 
  facet_wrap(vars(name), ncol = 1) +
  geom_point(
    data = filter(ozone_test_a, o3_tc == 300), 
    aes(x = o3_tc, y = plc50),
    colour = "red"
  ) + 
  geom_text_repel(
    data = filter(ozone_test_a, o3_tc == 300, name == "QUAMICHAN LAKE; CENTRE"), 
    aes(x = o3_tc, y = plc50),
    colour = "red", 
    label = "Recommended default = 300"
  ) +
  theme_bw() + 
  labs(
    title = "PLC50 for Anthracene at 3 sites in B.C. for a range of Ozone Total Column", 
    x = "Ozone Total Column",
    y = "PLC50 (μg/L)"
  )

ggplot(ozone_test_a, aes(x = o3_tc, y = plc_nlc_ratio)) +
  geom_point() + 
  facet_wrap(vars(name), ncol = 1) +
    geom_point(
    data = filter(ozone_test_a, o3_tc == 300), 
    aes(x = o3_tc, y = plc_nlc_ratio),
    colour = "red"
  ) + 
  geom_text_repel(
    data = filter(ozone_test_a, o3_tc == 300, name == "QUAMICHAN LAKE; CENTRE"), 
    aes(x = o3_tc, y = plc_nlc_ratio),
    colour = "red", 
    label = "Recommended default = 300"
  ) +
  theme_bw() + 
  labs(
    title = "Ratio of PLC50:NLC50 for Anthracene at 3 sites in B.C. for a range of Ozone Total Column", 
    x = "Ozone Total Column",
    y = "Ratio of PLC50:NLC50"
    )
```

### Effect of varying Ozone Total Column on PLC50 and ratio of PLC50:NLC50 for Benzo[a]pyrene

```{r hide_src=TRUE}
ozone_test_b <- multi_tuv(sites, 
                      pah = "Benzo[a]pyrene", 
                      varying = "o3_tc", 
                      vals = ozone_vals,
                      DOC = 5,
                      tauaer = 0.235)

ggplot(ozone_test_b, aes(x = o3_tc, y = plc50)) +
  geom_point() + 
  facet_wrap(vars(name), ncol = 1) +
  geom_point(
    data = filter(ozone_test_b, o3_tc == 300), 
    aes(x = o3_tc, y = plc50),
    colour = "red"
  ) + 
  geom_text_repel(
    data = filter(ozone_test_b, o3_tc == 300, name == "QUAMICHAN LAKE; CENTRE"), 
    aes(x = o3_tc, y = plc50),
    colour = "red", 
    label = "Recommended default = 300"
  ) +
  theme_bw() + 
  labs(
    title = "PLC50 for Benzo[a]pyrene at 3 sites in B.C. for a range of Ozone Total Column", 
    x = "Ozone Total Column",
    y = "PLC50 (μg/L)"
  )

ggplot(ozone_test_b, aes(x = o3_tc, y = plc_nlc_ratio)) +
  geom_point() + 
  facet_wrap(vars(name), ncol = 1) +
    geom_point(
    data = filter(ozone_test_b, o3_tc == 300), 
    aes(x = o3_tc, y = plc_nlc_ratio),
    colour = "red"
  ) + 
  geom_text_repel(
    data = filter(ozone_test_b, o3_tc == 300, name == "QUAMICHAN LAKE; CENTRE"), 
    aes(x = o3_tc, y = plc_nlc_ratio),
    colour = "red", 
    label = "Recommended default = 300"
  ) +
  theme_bw() + 
  labs(
    title = "Ratio of PLC50:NLC50 for Benzo[a]pyrene at 3 sites in B.C. for a range of Ozone Total Column", 
    x = "Ozone Total Column",
    y = "Ratio of PLC50:NLC50"
    )
```

## Aerosol Optical Depth (`tauaer`)

The pahwq package currently uses average monthly aerosol optical depth data from 
2002 to 2023, obtained from MODIS/Aqua satellite data. Based on latitude and 
longitude and month, the AOD value is looked up and supplied to the TUV model. 
This default behaviour can be overridden by supplying a value to the `tauaer` 
argument in the `set_tuv_aq_params` function. In the absence of
climatological data, the recommended default value is 0.235 (ARIS 2023).

To test the sensitivity of PLC50 to AOD, a range of values is tested from 0.1 
(clear skies with maximum visibility) to 1.0 (very hazy skies). See the 
[NASA Earth Observatory page on aerosols](https://earthobservatory.nasa.gov/global-maps/MODAL2_M_AER_OD).

```{r hide_src=TRUE}
aod_vals <- c(seq(0.1, 1.0, length.out = 10), 0.235)
```

### Effect of Varying Aerosol Optical Depth (AOD) on PLC50 and ratio of PLC50:NLC50 for Anthracene

```{r hide_src=TRUE}
aod_test_a <- multi_tuv(sites, 
                      pah = "Anthracene", 
                      varying = "tauaer", 
                      vals = aod_vals,
                      DOC = 5,
                      o3_tc = 300)

ggplot(aod_test_a, aes(x = tauaer, y = plc50)) +
  geom_point() + 
  facet_wrap(vars(name), ncol = 1) +
  geom_point(
    data = filter(aod_test_a, tauaer == 0.235), 
    aes(x = tauaer, y = plc50),
    colour = "red"
  ) + 
  geom_text_repel(
    data = filter(aod_test_a, tauaer == 0.235, name == "QUAMICHAN LAKE; CENTRE"), 
    aes(x = tauaer, y = plc50),
    colour = "red", 
    label = "Recommended default = 0.235",
    nudge_y = 0.1
  ) +
  theme_bw() + 
  labs(
    title = "PLC50 for Anthracene at 3 sites in B.C. for a range of Aeorosol Optical Depth", 
    x = "Aeorosol Optical Depth",
    y = "PLC50 (μg/L)"
  )

ggplot(aod_test_a, aes(x = tauaer, y = plc_nlc_ratio)) +
  geom_point() + 
  facet_wrap(vars(name), ncol = 1) +
  geom_point(
    data = filter(aod_test_a, tauaer == 0.235), 
    aes(x = tauaer, y = plc_nlc_ratio),
    colour = "red"
  ) + 
  geom_text_repel(
    data = filter(aod_test_a, tauaer == 0.235, name == "QUAMICHAN LAKE; CENTRE"), 
    aes(x = tauaer, y = plc_nlc_ratio),
    colour = "red", 
    label = "Recommended default = 0.235",
    nudge_y = 0.002
  ) +
  theme_bw() + 
  labs(
    title = "Ratio of PLC50:NLC50 for Anthracene at 3 sites in B.C. for a range of Aeorosol Optical Depth", 
    x = "Aeorosol Optical Depth",
    y = "Ratio of PLC50:NLC50"
    )
```

### Effect of varying Aerosol Optical Depth (AOD) on PLC50 and ratio of PLC50:NLC50 for Benzo[a]pyrene

```{r hide_src=TRUE}
aod_test_b <- multi_tuv(sites, 
                      pah = "Benzo[a]pyrene", 
                      varying = "tauaer", 
                      vals = aod_vals,
                      DOC = 5,
                      o3_tc = 300)

ggplot(aod_test_b, aes(x = tauaer, y = plc50)) +
  geom_point() + 
  facet_wrap(vars(name), ncol = 1) +
  geom_point(
    data = filter(aod_test_b, tauaer == 0.235), 
    aes(x = tauaer, y = plc50),
    colour = "red"
  ) + 
  geom_text_repel(
    data = filter(aod_test_b, tauaer == 0.235, name == "QUAMICHAN LAKE; CENTRE"), 
    aes(x = tauaer, y = plc50),
    colour = "red", 
    label = "Recommended default = 0.235",
    nudge_y = 0.002
  ) +
  theme_bw() + 
  labs(
    title = "PLC50 for Benzo[a]pyrene at 3 sites in B.C. for a range of Aeorosol Optical Depth", 
    x = "Aeorosol Optical Depth",
    y = "PLC50 (μg/L)"
  )

ggplot(aod_test_b, aes(x = tauaer, y = plc_nlc_ratio)) +
  geom_point() + 
  facet_wrap(vars(name), ncol = 1) +
    geom_point(
    data = filter(aod_test_b, tauaer == 0.235), 
    aes(x = tauaer, y = plc_nlc_ratio),
    colour = "red"
  ) + 
  geom_text_repel(
    data = filter(aod_test_b, tauaer == 0.235, name == "QUAMICHAN LAKE; CENTRE"), 
    aes(x = tauaer, y = plc_nlc_ratio),
    colour = "red", 
    label = "Recommended default = 0.235",
    nudge_y = 0.001
  ) +
  theme_bw() + 
  labs(
    title = "Ratio of PLC50:NLC50 for Benzo[a]pyrene at 3 sites in B.C. for a range of Aeorosol Optical Depth", 
    x = "Aeorosol Optical Depth",
    y = "Ratio of PLC50:NLC50"
    )
```

## Aerosol Single Scattering Albedo (`ssaaer`)

Aerosol Single Scattering Albedo is currently set as a default constant value of
0.99. This can be overridden by setting the `ssaaer` parameter of the 
`set_tuv_aq_params()` function to a different value. 

Here we test a range for values from 0.80 to 0.99, including the recommended 
default of 0.99 (ARIS 2023).

```{r hide_src=TRUE}
ssa_vals <- seq(0.8, 0.99, length.out = 10)
```

### Effect of varying Aerosol Single Scattering Albedo on PLC50 and ratio of PLC50:NLC50 for Anthracene

```{r hide_src=TRUE}
ssa_test_a <- multi_tuv(sites, 
                      pah = "Anthracene", 
                      varying = "ssaaer", 
                      vals = ssa_vals,
                      DOC = 5,
                      o3_tc = 300,
                      tauaer = 0.235)

ggplot(ssa_test_a, aes(x = ssaaer, y = plc50)) +
  geom_point() + 
  facet_wrap(vars(name), ncol = 1) +
    facet_wrap(vars(name), ncol = 1) +
  geom_point(
    data = filter(ssa_test_a, ssaaer == 0.99), 
    aes(x = ssaaer, y = plc50),
    colour = "red"
  ) + 
  geom_text_repel(
    data = filter(ssa_test_a, ssaaer == 0.99, name == "QUAMICHAN LAKE; CENTRE"), 
    aes(x = ssaaer, y = plc50),
    colour = "red", 
    label = "Recommended default = 0.99",
    nudge_y = .06
  ) +
  theme_bw() + 
  labs(
    title = "PLC50 for Anthracene at 3 sites in B.C. for a range of Aeorosol Single Scattering Albedo", 
    x = "Aeorosol Single Scattering Albedo",
    y = "PLC50 (μg/L)"
  )

ggplot(ssa_test_a, aes(x = ssaaer, y = plc_nlc_ratio)) +
  geom_point() + 
  facet_wrap(vars(name), ncol = 1) +
    geom_point(
    data = filter(ssa_test_a, ssaaer == 0.99), 
    aes(x = ssaaer, y = plc_nlc_ratio),
    colour = "red"
  ) + 
  geom_text_repel(
    data = filter(ssa_test_a, ssaaer == 0.99, name == "QUAMICHAN LAKE; CENTRE"), 
    aes(x = ssaaer, y = plc_nlc_ratio),
    colour = "red", 
    label = "Recommended default = 0.99",
    nudge_y = .001
  ) +
  theme_bw() + 
  labs(
    title = "Ratio of PLC50:NLC50 for Anthracene at 3 sites in B.C. for a range of Aeorosol Single Scattering Albedo", 
    x = "Aeorosol Single Scattering Albedo",
    y = "Ratio of PLC50:NLC50"
    )
```

### Effect of varying Aerosol Single Scattering Albedo on PLC50 and ratio of PLC50:NLC50 for Benzo[a]pyrene

```{r hide_src=TRUE}
ssa_test_b <- multi_tuv(sites, 
                      pah = "Benzo[a]pyrene", 
                      varying = "ssaaer", 
                      vals = ssa_vals,
                      DOC = 5,
                      o3_tc = 300,
                      tauaer = 0.235)

ggplot(ssa_test_b, aes(x = ssaaer, y = plc50)) +
  geom_point() + 
  facet_wrap(vars(name), ncol = 1) +
    geom_point(
    data = filter(ssa_test_b, ssaaer == 0.99), 
    aes(x = ssaaer, y = plc50),
    colour = "red"
  ) + 
  geom_text_repel(
    data = filter(ssa_test_b, ssaaer == 0.99, name == "QUAMICHAN LAKE; CENTRE"), 
    aes(x = ssaaer, y = plc50),
    colour = "red", 
    label = "Recommended default = 0.99",
    nudge_y = .001
  ) +
  theme_bw() + 
  labs(
    title = "PLC50 for Benzo[a]pyrene at 3 sites in B.C. for a range of Aeorosol Single Scattering Albedo", 
    x = "Aeorosol Single Scattering Albedo",
    y = "PLC50 (μg/L)"
  )

ggplot(ssa_test_b, aes(x = ssaaer, y = plc_nlc_ratio)) +
  geom_point() + 
  facet_wrap(vars(name), ncol = 1) +
      geom_point(
    data = filter(ssa_test_b, ssaaer == 0.99), 
    aes(x = ssaaer, y = plc_nlc_ratio),
    colour = "red"
  ) + 
  geom_text_repel(
    data = filter(ssa_test_b, ssaaer == 0.99, name == "QUAMICHAN LAKE; CENTRE"), 
    aes(x = ssaaer, y = plc_nlc_ratio),
    colour = "red", 
    label = "Recommended default = 0.99",
    nudge_y = .0005
  ) +
  theme_bw() + 
  labs(
    title = "Ratio of PLC50:NLC50 for Benzo[a]pyrene at 3 sites in B.C. for a range of Aeorosol Single Scattering Albedo", 
    x = "Aeorosol Single Scattering Albedo",
    y = "Ratio of PLC50:NLC50"
    )
```

## Latitude

Latitude has a strong effect on the angle of the sun, which will in turn affect
the light penetration through water, thus it is important to investigate the 
sensitivity of the calculation of PLC50 to variation in latitude.

For this analysis, we will maintain the longitudes associated with each site, 
and make "mock" sites by creating a range of latitudes from 48 to 72 degrees N 
and pair those with the longitudes of the original sites.

```{r}
lat_vals <- seq(48, 72, by = 2)
```


```{r hide_src=TRUE}
lat_test_a <- multi_tuv(sites, 
                      pah = "Anthracene", 
                      varying = "lat", 
                      vals = lat_vals,
                      DOC = 5,
                      o3_tc = 300,
                      tauaer = 0.235)

ggplot(lat_test_a, aes(x = lat, y = plc50)) +
  geom_point() + 
  facet_wrap(vars(lon), ncol = 1, labeller = as_labeller(\(x) paste("Longitude: ", x))) +
  theme_bw() + 
  labs(
    title = "PLC50 for Anthracene at 3 sites in B.C. for a range of latitudes", 
    x = "latitudes",
    y = "PLC50 (μg/L)"
  )

ggplot(lat_test_a, aes(x = lat, y = plc_nlc_ratio)) +
  geom_point() + 
  facet_wrap(vars(lon), ncol = 1, labeller = as_labeller(\(x) paste("Longitude: ", x))) +
  theme_bw() + 
  labs(
    title = "Ratio of PLC50:NLC50 for Anthracene at 3 sites in B.C. for a range of latitudes",
    x = "latitudes",
    y = "Ratio of PLC50:NLC50"
    )
```



## `lon`




## `elev_km`




## `nstr`

```{r}
#| eval: false
multi_tuv(sites, 
          pah = "Anthracene", 
          varying = "nstr", 
          vals = c(-2, 4), 
          DOC = 5,
          o3_tc = 300,
          tauaer = 0.235)
```



