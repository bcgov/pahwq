---
title: "Sensitivity Analysis"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Sensitivity Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 8,
  fig.height = 8
)
```

```{r}
#| include: false
library(sf)
library(mapview)
library(rems)
library(dplyr)
library(gt)
library(ggplot2)
library(ggrepel)
con <- connect_historic_db()
db <- attach_historic_data(con)
sites_sf <- db |> 
  filter(
    EMS_ID %in% c("0500236", "E207466", "0400390"),
    # grepl("(CHARLIE L)|(OKANAGAN)|(QUAMICHAN)", MONITORING_LOCATION), 
    COLLECTION_START > as.Date("2020-01-01"), PARAMETER_CODE == "1103"
  ) |> 
  collect() |> 
  st_as_sf(coords = c("LONGITUDE", "LATITUDE"), crs = 4326, remove = FALSE) |> 
  filter(!is.na(RESULT)) |> 
  arrange(desc(COLLECTION_START)) |> 
  group_by(EMS_ID, MONITORING_LOCATION, LONGITUDE, LATITUDE) |> 
  mutate(doc_min = min(RESULT), doc_max = max(RESULT)) |> 
  slice(1) |> 
  select(emsid = EMS_ID, 
         name = MONITORING_LOCATION, 
         lon = LONGITUDE, 
         lat = LATITUDE, 
         date = COLLECTION_START, 
         DOC = RESULT,
         doc_min,
         doc_max) |> 
  left_join(
    tribble(
      ~ emsid, ~elev_m,
      "E207466", 25,
      "0400390", 693,
      "0500236", 342
    ), by = join_by("emsid")
  ) |> 
  ungroup() |> 
  relocate(elev_m, .after = lat)

disconnect_historic_db(con)

`%||%` <- function(x, y) if (is.null(x)) y else x
```


```{r setup}
library(pahwq)
library(rems)
```

This report is to document the sensitivity of the TUV model, and the subsequent
calculation of water quality guidelines for PAHs, to variation in certain PAH
parameters.

## Input parameters

The input parameters for the calculation of light attenuation through water for
the TUV model are: 

  * Vertical Attenuation Coefficient at wavelength `wvl`: `kvat = Kd*exp(-Sk(ref_wvl-wvl)`
      - **`Kd`** Light attenuation coefficient (set directly or calculated from DOC)
      - **`Sk`** (default `0.018`)
      - **`ref_wvl`** Reference wavelength for Kd (default `305`)
  * **`depth_m`** Water depth in m
  * **`lat`** Latitude in decimal degrees
  * **`lon`** Longitude in decimal degrees
  * **`elev_km`** Surface elevation, km above sea level
  * **`year`** Year
  * **`month`** Month
  * **`day`** Day
  * **`tzone`** Timezone  Local Time - UTC (default `0`; UTC)
  * **`tstart`** Start time, hours local time (default `0`)
  * **`tstop`** Stop time, hours local time (default `23`)
  * **`tsteps`** Number of time steps (default `24`)
  * **`albedo`** Surface albedo (default `0.07`)
  * **`o3_tc`** Ozone column, Dobson Units (DU) - Looked up in climatology (recommended default `300`)
  * **`so2_tc`** SO2 column, DU (default `0`)
  * **`no2_tc`** NO2 column, DU (default `0`)
  * **`taucld`** Cloud optical depth (default `0`)
  * **`zbase`** Cloud base, km (default `4`)
  * **`ztop`** Cloud top, km (default `5`)
  * **`tauaer`** Aerosol optical depth at 550 nm - Looked up in climatology (recommended default `0.235`)
  * **`ssaaer`** Aerosol single scattering albedo (default `0.990`)
  * **`alpha`** Aerosol Angstrom exponent(default `1.0`) 
  * **`wvl_start`** Starting wavelength, nm (default `279.5`)
  * **`wvl_end`** End wavelength, nm (default `400.5`)
  * **`wvl_steps`** Number of wavelength intervals (default `121`)
  * **`nstr`** TUV run type; use -2 for fast, 4 for slightly more accurate (default `-2`)

Those currently under consideration for sensitivity analysis are:

  * **`Kd`** Light attenuation coefficient - includes use of **`DOC`** for calculating `Kd`
  * **`lat`** Latitude in decimal degrees
  * **`lon`** Longitude in decimal degrees
  * **`elev_km`** Surface elevation, km above sea level
  * **`albedo`** Surface albedo (default `0.07`)
  * **`o3_tc`** Ozone column, Dobson Units (DU) - Looked up in climatology (recommended default `300`)
  * **`tauaer`** Aerosol optical depth at 550 nm - Looked up in climatology (recommended default `0.235`)
  * **`ssaaer`** Aerosol single scattering albedo (default `0.990`)
  * **`nstr`** TUV run type; use -2 for fast, 4 for slightly more accurate (default `-2`)
  
The analyses will be conducted at three different sample lakes 
(Southern Interior, Vancouver Island, Northeast),
using two PAHs (Anthracene and Benzo[a]pyrene).

Initially, sensitivity analyses will be univariate (varying the input of interest
while holding the others constant). If there are significant interactions expected
between certain variables, these can be explored.

## Basic usage of the `pahwq` package

To calculate the acute phototoxic water quality guideline (PLC50) for Anthracene 
at 0.25 m depth in Okanagan Lake on June 21, 2023, with a measured DOC of 5 g/m^3, 
you would use the following code:

First, set up the options for the model run:
```{r}
set_tuv_aq_params(
  depth_m = 0.25,
  lat = 49.601632,
  lon = -119.605862,
  elev_km = 0.342,
  DOC = 5,
  date = "2023-06-21",
  tzone = -8,
  albedo = 0.05
)
```

You can view the options that will be used by TUV. Some are set via the function
inputs, and some are looked up:

```{r}
view_tuv_aq_params()
```

Run the TUV model and get the results. The results show the underwater irradiance 
at the specified depth, at each wavelength and time step.

```{r}
run_tuv()

# Get the results
res <- get_tuv_results(file = "out_irrad_y")
head(res)
```

Calculate the site-specific light absorption (P~abs~) for Anthracene from the 
TUV results. The `p_abs()` function uses a lookup table to get the molar 
absorption coefficient for the specified PAH.

```{r}
(Pabs <- p_abs(res, "Anthracene"))
```

Finally, calculate PLC50 in ðg/L, supplying the P~abs~ value and NLC50 (ðg/L):

```{r}
plc_50(Pabs, NLC50 = 450)
```

## Locations

```{r}
mapview(sites_sf, zcol = "name", legend = FALSE)
```

### Okanagan Lake, Okanagan

* EMS ID: 0500236
* Region: Okanagan 
* Latitude: 49.8614 N
* Longitude: 119.5134 W
* Site Depth: 70.1 m 
* Maximum Lake Depth: 232 m
* Lake Elevation: 342 m 
* Lake Surface Area: 350.08 sq km

### Charlie Lake, Peace

* EMS ID: 0400390
* Region: Peace 
* Latitude: 56.3125 N
* Longitude: 120.9642 W
* Site Depth: 13 m 
* Maximum Lake Depth: 13 m
* Lake Elevation: 693 m 
* Lake Surface Area: 17.56 sq km

### Quamichan Lake, Vancouver Island

* EMS ID: E207466
* Region: Vancouver Island 
* Latitude: 48.8003 N
* Longitude: 123.6625 W
* Site Depth: 7 m 
* Maximum Lake Depth: 8 m
* Lake Elevation: 25 m 
* Lake Surface Area: 2.88 sq km

### Prepare the data for comparisons, including setting the date to be the same
for all sites:

```{r}
#| echo: false
sites <- sites_sf |> 
  st_drop_geometry()
```

```{r}
sites <- sites |> 
  mutate(date = "2023-08-01")
gt(sites)
```

## Basic analysis using defaults:

A function allowing us to do multiple sites:

```{r}
multi_tuv <- function(df, site = "name", pah, varying, vals = NULL, ..., NLC50) {
  if (!varying %in% union(names(tuv_aq_defaults()), names(formals(set_tuv_aq_params)))) {
    stop(varying, " is not a valid argument for `set_tuv_aq_params()`")
  }
  
  if (!is.null(vals)) {
    var_df <- data.frame(vals)
    names(var_df) <- varying
    
    df <- df |> 
      select(!any_of(varying)) |> 
      dplyr::cross_join(var_df)
  }
  
  df |> 
    rowwise() |> 
    mutate(
      Pabs = calc_Pabs(
          date = date, 
          lat = lat, 
          lon = lon,
          elev_m = elev_m,
          pah = pah,
          varying = .data[[varying]],
          vary_var = varying,
          ...
        ),
      plc50 = plc_50(Pabs, NLC50),
      plc_nlc_ratio = plc50 / NLC50
    )
}

calc_Pabs <- function(date, lat, lon, elev_m, pah, varying, vary_var, ...) {
  args <- c(
    varying, 
    list(
      depth_m = 0.25,
      date = as.Date(date),
      lat = lat,
      lon = lon,
      elev_km = elev_m / 1000
    ),
    ...
  )
  names(args)[1] <- vary_var
  
  do.call("set_tuv_aq_params", args)
  
  run_tuv(quiet = TRUE)
  res <- get_tuv_results(file = "out_irrad_y")
  p_abs(res, pah)
}
```

Calculate Ratio of PLC50:NLC50 for Anthracene using recorded DOC:


```{r}
diff_doc <- multi_tuv(sites, pah = "Anthracene", varying = "DOC", NLC50 = 450)
```

```{r}
#| echo: false
diff_doc |>
  select(-doc_min, -doc_max) |>
  gt() |>
  data_color(columns = plc50, palette = "Greens")
```

Calculate Ratio of PLC50:NLC50 for Anthracene using constant DOC = 5: 

```{r}
same_doc <- sites |>
  mutate(DOC = 5) |>
  multi_tuv(pah = "Anthracene", varying = "DOC", NLC50 = 450)
```

```{r}
#| echo: false
same_doc |>
  select(-doc_min, -doc_max) |>
  gt() |>
  data_color(columns = plc50, palette = "Greens")
```


## `Kd`

Using sample Kd values from Table 3 (ARIS 2023a), from 0.08 to 275

```{r}
kd_vals <- seq(0.08, 275, length.out = 20)
```

### Kd for Anthracene

```{r}
kd_test_a <- multi_tuv(sites, 
                      pah = "Anthracene", 
                      varying = "Kd_ref", 
                      vals = kd_vals, 
                      Kd_wvl = 305,
                      NLC50 = 450)

ggplot(kd_test_a, aes(x = Kd_ref, y = plc50)) +
  geom_point() + 
  facet_wrap(vars(name), ncol = 1) +
  theme_bw() + 
  labs(
    title = "PLC50 for Anthracene at 3 sites in B.C. for a range of Kd(305)", 
    x = "Kd(305)",
    y = "PLC50 (ug/L)"
    )

ggplot(kd_test_a, aes(x = Kd_ref, y = plc_nlc_ratio)) +
  geom_point() + 
  facet_wrap(vars(name), ncol = 1) +
  theme_bw() + 
  labs(
    title = "Ratio of PLC50:NLC50 for Anthracene at 3 sites in B.C. for a range of Kd(305)", 
    x = "Kd(305)",
    y = "Ratio of PLC50:NLC50"
    )
```

### Kd for Benzo[a]pyrene

```{r}
kd_test_b <- multi_tuv(sites, 
                      pah = "Benzo[a]pyrene", 
                      varying = "Kd_ref", 
                      vals = kd_vals, 
                      NLC50 = 450)

ggplot(kd_test_b, aes(x = Kd_ref, y = plc50)) +
  geom_point() + 
  facet_wrap(vars(name), ncol = 1) +
  theme_bw() + 
  labs(
    title = "PLC50 for Benzo[a]pyrene at 3 sites in B.C. for a range of Kd(305)", 
    x = "Kd(305)",
    y = "PLC50 (ug/L)"
    )

ggplot(kd_test_b, aes(x = Kd_ref, y = plc_nlc_ratio)) +
  geom_point() + 
  facet_wrap(vars(name), ncol = 1) +
  theme_bw() + 
  labs(
    title = "Ratio of PLC50:NLC50 for Benzo[a]pyrene at 3 sites in B.C. for a range of Kd(305)", 
    x = "Kd(305)",
    y = "Ratio of PLC50:NLC50"
    )
```


## `albedo`

Using sample Surface values from 0.05 to 0.1 (as suggested in ARIS 2023b):

```{r}
albedo_vals <- c(seq(0.05, 0.1, length.out = 10), 0.07)
```

We will set DOC = 5 for all sites.

### Surface Albedo for Anthracene

```{r}
albedo_test_a <- multi_tuv(sites, 
                      pah = "Anthracene", 
                      varying = "albedo", 
                      vals = albedo_vals,
                      DOC = 5,
                      NLC50 = 450)

ggplot(albedo_test_a, aes(x = albedo, y = plc50)) +
  geom_point() + 
  facet_wrap(vars(name), ncol = 1) +
  geom_point(
    data = filter(albedo_test_a, albedo == 0.07), 
    aes(x = albedo, y = plc50),
    colour = "red"
  ) + 
  geom_text_repel(
    data = filter(albedo_test_a, albedo == 0.07, name == "QUAMICHAN LAKE; CENTRE"), 
    aes(x = albedo, y = plc50),
    colour = "red", 
    label = "Recommended default = 0.07",
    nudge_x = 0.001,
    nudge_y = 0.25
  ) +
  theme_bw() + 
  labs(
    title = "PLC50 for Anthracene at 3 sites in B.C. for a range of Surface Albedo", 
    x = "Surface Albedo",
    y = "PLC50 (ug/L)"
  )

ggplot(albedo_test_a, aes(x = albedo, y = plc_nlc_ratio)) +
  geom_point() + 
  facet_wrap(vars(name), ncol = 1) +
    geom_point(
    data = filter(albedo_test_a, albedo == 0.07), 
    aes(x = albedo, y = plc_nlc_ratio),
    colour = "red"
  ) + 
  geom_text_repel(
    data = filter(albedo_test_a, albedo == 0.07, name == "QUAMICHAN LAKE; CENTRE"), 
    aes(x = albedo, y = plc_nlc_ratio),
    colour = "red", 
    label = "Recommended default = 0.07",
    nudge_x = 0.001,
    nudge_y = 0.0005
  ) +
  theme_bw() + 
  labs(
    title = "Ratio of PLC50:NLC50 for Anthracene at 3 sites in B.C. for a range of Surface Albedo", 
    x = "Surface Albedo",
    y = "Ratio of PLC50:NLC50"
    )
```

### Surface Albedo for Benzo[a]pyrene

```{r}
albedo_test_b <- multi_tuv(sites, 
                      pah = "Benzo[a]pyrene", 
                      varying = "albedo", 
                      vals = albedo_vals,
                      DOC = 5,
                      NLC50 = 450)

ggplot(albedo_test_b, aes(x = albedo, y = plc50)) +
  geom_point() + 
  facet_wrap(vars(name), ncol = 1) +
    geom_point(
    data = filter(albedo_test_b, albedo == 0.07), 
    aes(x = albedo, y = plc50),
    colour = "red"
  ) + 
  geom_text_repel(
    data = filter(albedo_test_b, albedo == 0.07, name == "QUAMICHAN LAKE; CENTRE"), 
    aes(x = albedo, y = plc50),
    colour = "red", 
    label = "Recommended default = 0.07",
    nudge_x = 0.001,
    nudge_y = 0.1
  ) +
  theme_bw() + 
  labs(
    title = "PLC50 for Benzo[a]pyrene at 3 sites in B.C. for a range of Surface Albedo", 
    x = "Surface Albedo",
    y = "PLC50 (ug/L)"
    )

ggplot(albedo_test_b, aes(x = albedo, y = plc_nlc_ratio)) +
  geom_point() + 
  facet_wrap(vars(name), ncol = 1) +
    geom_point(
    data = filter(albedo_test_b, albedo == 0.07), 
    aes(x = albedo, y = plc_nlc_ratio),
    colour = "red"
  ) + 
  geom_text_repel(
    data = filter(albedo_test_b, albedo == 0.07, name == "QUAMICHAN LAKE; CENTRE"), 
    aes(x = albedo, y = plc_nlc_ratio),
    colour = "red", 
    label = "Recommended default = 0.07",
    nudge_x = 0.001,
    nudge_y = 0.0003
  ) +
  theme_bw() + 
  labs(
    title = "Ratio of PLC50:NLC50 for Benzo[a]pyrene at 3 sites in B.C. for a range of Surface Albedo", 
    x = "Surface Albedo",
    y = "Ratio of PLC50:NLC50"
    )
```


## `o3_tc` (Ozone Column)

* Currently getting from historic climatology, could update to use modern data (similar to aerosol)
* Recommended test range 320-420 DU

## `tauaer` (Aerosol Optical Depth)

* Getting from MODIS satellite data (monthly averages from 2002 - 2023, 1 degree resolution)
* Recommended test range 0.1-1.0

## `ssaaer` (Aerosol Scattering Albedo)

* Currently set as a constant value of 0.99
* recommended test range: 0.80 - 0.98



## `lat`




## `lon`




## `elev_km`




## `nstr`




