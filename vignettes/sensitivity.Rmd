---
title: "Sensitivity Analysis"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Sensitivty Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r}
#| include: false
library(sf)
library(mapview)
library(rems)
library(dplyr)
library(gt)
con <- connect_historic_db()
db <- attach_historic_data(con)
sites_sf <- db |> 
  filter(
    EMS_ID %in% c("0500236", "E207466", "0400390"),
    # grepl("(CHARLIE L)|(OKANAGAN)|(QUAMICHAN)", MONITORING_LOCATION), 
    COLLECTION_START > as.Date("2020-01-01"), PARAMETER_CODE == "1103"
  ) |> 
  collect() |> 
  st_as_sf(coords = c("LONGITUDE", "LATITUDE"), crs = 4326, remove = FALSE) |> 
  filter(!is.na(RESULT)) |> 
  arrange(desc(COLLECTION_START)) |> 
  group_by(EMS_ID, MONITORING_LOCATION, LONGITUDE, LATITUDE) |> 
  mutate(doc_min = min(RESULT), doc_max = max(RESULT)) |> 
  slice(1) |> 
  select(emsid = EMS_ID, 
         name = MONITORING_LOCATION, 
         lon = LONGITUDE, 
         lat = LATITUDE, 
         date = COLLECTION_START, 
         DOC = RESULT,
         doc_min,
         doc_max) |> 
  left_join(
    tribble(
      ~ emsid, ~elev_m,
      "E207466", 25,
      "0400390", 693,
      "0500236", 342
    ), by = join_by("emsid")
  ) |> 
  ungroup() |> 
  relocate(elev_m, .after = lat)

`%||%` <- function(x, y) if (is.null(x)) y else x
```


```{r setup}
library(pahwq)
library(rems)
```

This report is to document the sensitivity of the TUV model, and the subsequent
calculation of water quality guidelines for PAHs, to variation in certain PAH
parameters.

## Input parameters

The input parameters for the calculation of light attenuation through water for
the TUV model are: 

  * Vertical Attenuation Coefficient at wavelength `wvl`: `kvat = Kd*exp(-Sk(ref_wvl-wvl)`
      - **`Kd`** Light attenuation coefficient (set directly or calculated from DOC)
      - **`Sk`** (default `0.018`)
      - **`ref_wvl`** Reference wavelength for Kd (default `305`)
  * **`depth_m`** Water depth in m
  * **`lat`** Latitude in decimal degrees
  * **`lon`** Longitude in decimal degrees
  * **`elev_km`** Surface elevation, km above sea level
  * **`year`** Year
  * **`month`** Month
  * **`day`** Day
  * **`tzone`** Timezone  Local Time - UTC (default `0`; UTC)
  * **`tstart`** Start time, hours local time (default `0`)
  * **`tstop`** Stop time, hours local time (default `23`)
  * **`tsteps`** Number of time steps (default `24`)
  * **`albedo`** Surface albedo (default `0.07`)
  * **`o3_tc`** Ozone column, Dobson Units (DU) - Looked up in climatology (recommended default `300`)
  * **`so2_tc`** SO2 column, DU (default `0`)
  * **`no2_tc`** NO2 column, DU (default `0`)
  * **`taucld`** Cloud optical depth (default `0`)
  * **`zbase`** Cloud base, km (default `4`)
  * **`ztop`** Cloud top, km (default `5`)
  * **`tauaer`** Aerosol optical depth at 550 nm - Looked up in climatology (recommended default `0.235`)
  * **`ssaaer`** Aerosol single scattering albedo (default `0.990`)
  * **`alpha`** Aerosol Angstrom exponent(default `1.0`) 
  * **`wvl_start`** Starting wavelength, nm (default `279.5`)
  * **`wvl_end`** End wavelength, nm (default `400.5`)
  * **`wvl_steps`** Number of wavelength intervals (default `121`)
  * **`nstr`** TUV run type; use -2 for fast, 4 for slightly more accurate (default `-2`)

Those currently under consideration for sensitivity analysis are:

  * **`Kd`** Light attenuation coefficient - includes use of **`DOC`** for calculating `Kd`
  * **`lat`** Latitude in decimal degrees
  * **`lon`** Longitude in decimal degrees
  * **`elev_km`** Surface elevation, km above sea level
  * **`albedo`** Surface albedo (default `0.07`)
  * **`o3_tc`** Ozone column, Dobson Units (DU) - Looked up in climatology (recommended default `300`)
  * **`tauaer`** Aerosol optical depth at 550 nm - Looked up in climatology (recommended default `0.235`)
  * **`nstr`** TUV run type; use -2 for fast, 4 for slightly more accurate (default `-2`)
  
The analyses will be conducted at three different sample lakes 
(Southern Interior, Vancouver Island, Northeast),
using two PAHs (Anthracene and Benzo[a]pyrene).

Initially, sensitivity analyses will be univariate (varying the input of interest
while holding the others constant). If there are significant interactions expected
between certain variables, these can be explored.

## Basic usage of the `pahwq` package

To calculate the acute phototoxic water quality guideline (PLC50) for Anthracene 
at 0.25 m depth in Okanagan Lake on June 21, 2023, with a measured DOC of 5 g/m^3, 
you would use the following code:

First, set up the options for the model run:
```{r}
set_tuv_aq_params(
  depth_m = 0.25,
  lat = 49.601632,
  lon = -119.605862,
  elev_km = 0.342,
  DOC = 5,
  date = "2023-06-21",
  tzone = -8
)
```

You can view the options that will be used by TUV. Some are set via the function
inputs, and some are looked up:

```{r}
view_tuv_aq_params()
```

Run the TUV model and get the results. The results show the underwater irradiance 
at the specified depth, at each wavelength and time step.

```{r}
run_tuv()

# Get the results
res <- get_tuv_results(file = "out_irrad_y")
head(res)
```

Calculate the site-specific light absorption (P~abs~) for Anthracene from the 
TUV results. The `p_abs()` function uses a lookup table to get the molar 
absorption coefficient for the specified PAH.

```{r}
(Pabs <- p_abs(res, "Anthracene"))

# Calculate PLC50
plc_50(Pabs, NLC50 = 450)
```

## Locations

```{r}
#| fig-width: 6
#| fig-height: 6
mapview(sites_sf, zcol = "name", legend = FALSE)
```

### Okanagan Lake, Okanagan

* EMS ID: 0500236
* Region: Okanagan 
* Latitude: 49.8614 N
* Longitude: 119.5134 W
* Site Depth: 70.1 m 
* Maximum Lake Depth: 232 m
* Lake Elevation: 342 m 
* Lake Surface Area: 350.08 sq km

### Charlie Lake, Peace

* EMS ID: 0400390
* Region: Peace 
* Latitude: 56.3125 N
* Longitude: 120.9642 W
* Site Depth: 13 m 
* Maximum Lake Depth: 13 m
* Lake Elevation: 693 m 
* Lake Surface Area: 17.56 sq km

### Quamichan Lake, Vancouver Island

* EMS ID: E207466
* Region: Vancouver Island 
* Latitude: 48.8003 N
* Longitude: 123.6625 W
* Site Depth: 7 m 
* Maximum Lake Depth: 8 m
* Lake Elevation: 25 m 
* Lake Surface Area: 2.88 sq km

```{r}
#| echo: false
sites <- sites_sf |> 
  st_drop_geometry()
gt(sites)
```

## Basic analysis using defaults:

A function allowing us to do multiple sites:

```{r}
multi_site <- function(df, depth = 0.25, pah, nlc50) {
  df_split <- split(df, df$name)
  
  all_res <- vapply(
    df_split, 
    calc_plc50,
    depth = depth,
    pah = pah, 
    nlc50 = nlc50,
    FUN.VALUE = numeric(1)
  )
  cbind(df, plc50 = all_res)
}

calc_plc50 <- function(x, depth, pah, nlc50) {
  set_tuv_aq_params(
    depth_m = depth,
    date = as.Date(x$date),
    lat = x$lat,
    lon = x$lon,
    elev_km = x$elev_m / 1000,
    DOC = x$DOC
  )
  run_tuv()
  res <- get_tuv_results(file = "out_irrad_y")
  Pabs <- p_abs(res, pah)
  plc_50(Pabs, nlc50)
}
```

Calculate PLC50 for Anthracene using recorded DOC: 

```{r}
diff_doc <- multi_site(sites, pah = "Anthracene", nlc50 = 450)
```

```{r}
#| echo: false
diff_doc |> 
  select(-doc_min, -doc_max) |> 
  gt() |> 
  data_color(columns = plc50, palette = "Greens")
```

Calculate PLC50 for Anthracene using constant DOC = 5: 

```{r}
same_doc <- sites |> 
  mutate(DOC = 5) |> 
  multi_site(pah = "Anthracene", nlc50 = 450)
```

```{r}
#| echo: false
same_doc |> 
  select(-doc_min, -doc_max) |> 
  gt() |> 
  data_color(columns = plc50, palette = "Greens")
```


## `Kd`




## `lat`




## `lon`




## `elev_km`




## `albedo`




## `o3_tc`




## `tauaer`




## `nstr`




